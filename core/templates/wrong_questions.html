{% comment %} core/templates/wrong_questions.html {% endcomment %}
{% load static %}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title|default:"æˆ‘çš„éŒ¯é¡Œæœ¬" }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding-top: 20px; }
        .container { max-width: 960px; }
        .list-group-item { margin-bottom: 1rem; }
        .alert-info { margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .action-buttons .btn { margin-left: 5px; margin-top: 5px; }
        /* â­ ç‚ºç¯©é¸æ§åˆ¶æŒ‰éˆ•çµ±ä¸€æ¨£å¼ â­ */
        .filter-controls a.btn, .filter-controls button.btn { 
            margin-right: 5px; 
            margin-bottom: 10px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>{{ page_title }}</h2>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">è¿”å›ä¸»é </a>
        </div>
        <hr>

        {# ä¿®æ”¹ç¯©é¸å€åŸŸï¼ŒåŒ…å«ä¸»é¡Œç¯©é¸å’Œæª¢è¦–æ¨¡å¼åˆ‡æ› #}
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 filter-controls">
            {# --- Topic ç¯©é¸å€åŸŸ (ä¿æŒæ‚¨ç¾æœ‰çš„) --- #}
            <div class="topic-filter">
                <strong>ç¯©é¸ä¸»é¡Œï¼š</strong>
                <a href="{% url 'my_wrong_questions' %}?view_mode={{ current_view_mode|default:'unfixed' }}&topic=all" 
                   class="btn btn-sm {% if current_topic == 'all' or not current_topic %}btn-primary{% else %}btn-outline-primary{% endif %}">å…¨éƒ¨ä¸»é¡Œ</a>
                {% for topic_name_filter in available_topics %}
                    <a href="{% url 'my_wrong_questions' %}?view_mode={{ current_view_mode|default:'unfixed' }}&topic={{ topic_name_filter }}" 
                       class="btn btn-sm {% if current_topic == topic_name_filter %}btn-primary{% else %}btn-outline-primary{% endif %}">{{ topic_name_filter|capfirst }}</a>
                {% endfor %}
            </div>

            {#  æ–°å¢/ä¿®æ”¹ï¼šæª¢è¦–æ¨¡å¼åˆ‡æ›æŒ‰éˆ•  #}
            <div class="view-mode-toggle">
                {% if current_view_mode == 'fixed' %}
                    <a href="{% url 'my_wrong_questions' %}?topic={{ current_topic|default:'all' }}&view_mode=unfixed" 
                       class="btn btn-sm btn-info">æŸ¥çœ‹å¾…è¤‡ç¿’çš„éŒ¯é¡Œ</a>
                {% else %} {# é è¨­æ˜¯ unfixed æ¨¡å¼ï¼Œæ‰€ä»¥æŒ‰éˆ•æ˜¯æŸ¥çœ‹ fixed #}
                    <a href="{% url 'my_wrong_questions' %}?topic={{ current_topic|default:'all' }}&view_mode=fixed" 
                       class="btn btn-sm btn-outline-info">æŸ¥çœ‹å·²å­¸æœƒçš„éŒ¯é¡Œ</a>
                {% endif %}
            </div>
        </div>
        {# --- ç¯©é¸å€åŸŸçµæŸ --- #}

        {% if wrong_questions %}
            <ul class="list-group list-group-flush" id="wrong-question-list">
                {% for wq in wrong_questions %}
                    <li class="list-group-item" id="wrong-question-item-{{ wq.id }}">
                        <h5 class="mb-1">é¡Œç›® {{ forloop.counter }} (ä¸»é¡Œ: {{ wq.question.topic|capfirst }}):</h5>
                        <p>{{ wq.question.content|linebreaksbr }}</p>
                        {% if wq.note %}
                        <div class="alert alert-info" role="alert">
                            <strong>æˆ‘çš„ç­†è¨˜ï¼š</strong> {{ wq.note|linebreaksbr }}
                        </div>
                        {% endif %}
                        <p><small class="text-muted">
                            {% if wq.is_fixed and wq.fixed_dt %}
                                æ–¼ {{ wq.fixed_dt|date:"Y-m-d H:i" }} æ¨™è¨˜ç‚ºå·²å­¸æœƒ (åŸç­”éŒ¯æ™‚é–“: {{ wq.last_wrong_time|date:"Y-m-d H:i" }})
                            {% else %}
                                æœ€å¾Œç­”éŒ¯æ™‚é–“ï¼š{{ wq.last_wrong_time|date:"Y-m-d H:i" }}
                            {% endif %}
                        </small></p>
                        
                        <div class="action-buttons mt-2">
                            <a href="{% url 'gpt_detail' %}?qid={{ wq.question.id }}" class="btn btn-sm btn-info">æŸ¥çœ‹ GPT è©³è§£</a>
                            {# ã€Œå·²å­¸æœƒã€æŒ‰éˆ•åªåœ¨æŸ¥çœ‹ã€Œæœªå­¸æœƒã€åˆ—è¡¨ (current_view_mode == 'unfixed') æ™‚é¡¯ç¤º #}
                            {% if current_view_mode == 'unfixed' %} 
                            <button type="button" class="btn btn-sm btn-success mark-as-fixed-btn" data-wq-id="{{ wq.id }}">
                                âœ“ æˆ‘å·²å­¸æœƒ
                            </button>
                            {% endif %}
                            {# å¦‚æœæ˜¯å·²å­¸æœƒåˆ—è¡¨ï¼Œä¸¦ä¸”æ‚¨å°‡ä¾†æƒ³åŠ å…¥ã€Œæ¨™è¨˜ç‚ºæœªå­¸æœƒã€åŠŸèƒ½ï¼Œå¯ä»¥åœ¨é€™è£¡åŠ æŒ‰éˆ• #}
                        </div>
                        <div class="mark-fixed-message mt-1 small" style="min-height: 1.2em;"></div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="alert alert-success mt-3" role="alert">
                {% if current_view_mode == 'fixed' %}
                    {% if current_topic == 'all' or not current_topic %}
                        æ‚¨é‚„æ²’æœ‰æ¨™è¨˜ä»»ä½•éŒ¯é¡Œç‚ºã€Œå·²å­¸æœƒã€ã€‚
                    {% else %}
                        æ‚¨åœ¨ã€Œ{{ current_topic|capfirst }}ã€é€™å€‹ä¸»é¡Œä¸‹æ²’æœ‰æ¨™è¨˜ç‚ºã€Œå·²å­¸æœƒã€çš„éŒ¯é¡Œã€‚
                    {% endif %}
                {% else %} {# unfixed or default #}
                    {% if current_topic == 'all' or not current_topic %}
                        å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰éœ€è¦è¤‡ç¿’çš„éŒ¯é¡Œï¼ ğŸ‰
                    {% else %}
                        å¤ªæ£’äº†ï¼ä½ åœ¨ã€Œ{{ current_topic|capfirst }}ã€é€™å€‹ä¸»é¡Œä¸‹æ²’æœ‰éœ€è¦è¤‡ç¿’çš„éŒ¯é¡Œï¼ğŸ‰
                    {% endif %}
                {% endif %}
            </div>
        {% endif %}
    </div>

    {% csrf_token %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            document.querySelectorAll('.mark-as-fixed-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const wrongQuestionId = this.dataset.wqId;
                    const listItem = this.closest('li.list-group-item');
                    const messageDiv = listItem.querySelector('.mark-fixed-message');

                    if (!wrongQuestionId) { console.error("éŒ¯èª¤ï¼šæŒ‰éˆ•ç¼ºå°‘ data-wq-id å±¬æ€§ã€‚"); if(messageDiv){messageDiv.textContent = 'éŒ¯èª¤ï¼šç„¡æ³•è­˜åˆ¥é¡Œç›®ã€‚'; messageDiv.style.color = 'red';} return; }
                    if (!confirm("ç¢ºå®šè¦å°‡æ­¤é¡Œæ¨™è¨˜ç‚ºã€Œå·²å­¸æœƒã€å—ï¼Ÿæ¨™è¨˜å¾Œå°‡å¾æ­¤åˆ—è¡¨ç§»é™¤ã€‚")) { return; }
                    if(messageDiv) { messageDiv.textContent = 'è™•ç†ä¸­...'; messageDiv.style.color = 'blue';}
                    
                    const url = `/wrong-question/mark-fixed/${wrongQuestionId}/`; 

                    fetch(url, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrftoken },
                    })
                    .then(response => { if (!response.ok) { return response.json().then(errData => { throw new Error(errData.message || `è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š${response.status}`); }).catch(() => { throw new Error(`è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š${response.status}, ä¼ºæœå™¨å›æ‡‰éJSONæ ¼å¼`); }); } return response.json(); })
                    .then(data => {
                        if (data.status === 'success') {
                            if(messageDiv) { messageDiv.textContent = data.message || 'é¡Œç›®å·²æˆåŠŸæ¨™è¨˜ç‚ºå·²å­¸æœƒï¼'; messageDiv.style.color = 'green';}
                            if (listItem) { 
                                listItem.style.transition = 'opacity 0.5s ease-out';
                                listItem.style.opacity = '0';
                                setTimeout(() => {
                                    listItem.remove();
                                    const list = document.getElementById('wrong-question-list');
                                    if (list && list.children.length === 0) {
                                        const containerDiv = document.querySelector('.container');
                                        let alertDiv = containerDiv.querySelector('.alert-success');
                                        if (!alertDiv) { 
                                            alertDiv = document.createElement('div');
                                            alertDiv.className = 'alert alert-success mt-3';
                                            alertDiv.setAttribute('role', 'alert');
                                            const topicFilterDiv = containerDiv.querySelector('.filter-controls'); // æ‰¾ filter-controls
                                            if (topicFilterDiv && topicFilterDiv.nextSibling) {
                                                topicFilterDiv.parentNode.insertBefore(alertDiv, topicFilterDiv.nextSibling);
                                            } else if (topicFilterDiv) {
                                                 topicFilterDiv.insertAdjacentElement('afterend', alertDiv);
                                            } else { containerDiv.appendChild(alertDiv); }
                                        }
                                        const currentViewModeForMsg = document.querySelector('.view-mode-toggle .btn-primary')?.textContent.includes("å¾…è¤‡ç¿’") ? "unfixed" : "fixed"; // å¾æŒ‰éˆ•ç‹€æ…‹æ¨æ–·
                                        const currentTopicFilterText = document.querySelector('.topic-filter .btn-primary')?.textContent.trim() || "å…¨éƒ¨";
                                        
                                        if (currentViewModeForMsg === 'fixed') {
                                            if (currentTopicFilterText === "å…¨éƒ¨ä¸»é¡Œ"){
                                                alertDiv.innerHTML = 'æ‚¨é‚„æ²’æœ‰æ¨™è¨˜ä»»ä½•éŒ¯é¡Œç‚ºã€Œå·²å­¸æœƒã€ã€‚';
                                            } else {
                                                alertDiv.innerHTML = `æ‚¨åœ¨ã€Œ${currentTopicFilterText}ã€é€™å€‹ä¸»é¡Œä¸‹æ²’æœ‰æ¨™è¨˜ç‚ºã€Œå·²å­¸æœƒã€çš„éŒ¯é¡Œã€‚`;
                                            }
                                        } else {
                                            if (currentTopicFilterText === "å…¨éƒ¨ä¸»é¡Œ"){
                                                alertDiv.innerHTML = 'å¤ªæ£’äº†ï¼ä½ çš„éŒ¯é¡Œæœ¬ç›®å‰æ˜¯ç©ºçš„ï¼ˆæ²’æœ‰æœªå­¸æœƒçš„éŒ¯é¡Œï¼‰ï¼ ğŸ‰';
                                            } else {
                                                alertDiv.innerHTML = `å¤ªæ£’äº†ï¼ä½ åœ¨ã€Œ${currentTopicFilterText}ã€é€™å€‹ä¸»é¡Œä¸‹æ²’æœ‰éœ€è¦è¤‡ç¿’çš„éŒ¯é¡Œï¼ˆæ²’æœ‰æœªå­¸æœƒçš„éŒ¯é¡Œï¼‰ï¼ğŸ‰`;
                                            }
                                        }
                                        alertDiv.style.display = 'block';
                                        if(list) list.style.display = 'none';
                                    }
                                }, 500); 
                            }
                        } else { if(messageDiv) { messageDiv.textContent = (data.status === 'info' ? 'æç¤ºï¼š' : 'éŒ¯èª¤ï¼š') + (data.message || 'æ“ä½œæœªæˆåŠŸã€‚'); messageDiv.style.color = (data.status === 'info' ? 'blue' : 'red');}}
                    })
                    .catch(error => { console.error('Error marking question as fixed:', error); if(messageDiv) { messageDiv.textContent = 'æ“ä½œéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message; messageDiv.style.color = 'red';}});
                });
            });
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
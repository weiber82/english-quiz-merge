{% load static %}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡Œç›®å“è³ªæŸ¥è©¢èˆ‡å›è¦†</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { padding-top: 20px; } /* ç°¡å–®çš„é é¢é‚Šè· */
        .container { max-width: 960px; }
        .list-group-item { margin-bottom: 1rem; }
        .alert-info { margin-top: 0.5rem; margin-bottom: 0.5rem; }
        
        .accordion-toggle-btn {
            display: block;
            width: 100%;
            text-align: left;
            background-color: #f8f9fa;
            border: none;
            font-weight: bold;
            padding: 12px 16px;
            font-size: 1.05rem;
            transition: background-color 0.3s ease;
        }
      
        .accordion-toggle-btn:hover {
            text-decoration: none !important;
            background-color: #e2e6ea;
            cursor: pointer;
        }
      
        .accordion-toggle-btn:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        .bi {
            font-size: 1.2rem;
            cursor: pointer;
          }
    </style>
    {{ topic_distribution|json_script:"topic-data" }}
</head>
<body>
    <div class="container">
        {% if messages %}
          <div id="alert-container">
            {% for message in messages %}
              <div id="alertBox" class="alert alert-danger alert-dismissible fade show" role="alert">
              {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>é¡Œç›®å“è³ªæŸ¥è©¢èˆ‡å›è¦†ï¼ˆA5ï¼‰</h2>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">è¿”å›ä¸»é </a>
        </div>
        <hr>
        <canvas id="topicPieChart" width="400" height="400"></canvas>
        <div id="question-list-container">
        </div>
    </div>
    <footer class="bg-light text-center text-muted py-3">
    </footer>
    
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script>
        const expandedQuestions = new Set();
        function loadQuestionList(topic) {
          fetch(`/quality/index/?topic=${encodeURIComponent(topic)}`)
              .then(response => response.text())
              .then(html => {
                  document.getElementById('question-list-container').innerHTML = html;
              });
          }

        function loadPage(topic, page) {
            fetch(`/quality/index/?topic=${encodeURIComponent(topic)}&page=${page}`)
              .then(response => response.text())
              .then(html => {
                const container = document.getElementById('question-list-container');
                container.innerHTML = html;
          
                // å»¶é²ä»¥ç¢ºä¿ DOM å°±ç·’ï¼Œå†æ¢å¾©æŠ˜ç–Š
                requestAnimationFrame(() => {
                  expandedQuestions.forEach(qid => {
                    const targetDiv = document.getElementById(`option-stats-${qid}`);
                    if (targetDiv) {
                      expandOptionChart(qid);  // ğŸŸ¢ åªæ¸²æŸ“ï¼Œä¸å†æ”¹è®Š Set ç‹€æ…‹
                    }
                  });
                });
          
                window.scrollTo({
                  top: container.offsetTop,
                  behavior: 'smooth'
                });
              });
          }
        


      const topicData = JSON.parse(document.getElementById('topic-data').textContent);
      const topicNameMap = {
        'vocab': 'å­—å½™',
        'grammar': 'æ–‡æ³•',
        'cloze': 'å…‹æ¼å­—',
        'reading': 'é–±è®€',
        'all': 'å…¨éƒ¨'
      };
      const pieLabels = topicData.map(item => topicNameMap[item.topic] || item.topic);
      const pieCounts = topicData.map(item => item.count);
  
      const data = {
          labels: pieLabels,
          datasets: [{
              data: pieCounts,
              backgroundColor: ['#f38b4a', '#56d798', '#ff8397', '#6970d5', '#ffe29a'],
              hoverOffset: 4
          }]
      };
      
      Chart.register(ChartDataLabels);
      const config = {
          type: 'pie',
          data: data,
          options: {
              responsive: true,
              maintainAspectRatio: true,
              aspectRatio: 1.2,
              plugins: {
                  datalabels: {
                    listeners: false,
                    formatter: function(value, context) {
                      const index = context.dataIndex;
                      const topic = pieLabels[index];
                      const rating = topicData[index].avg_rating || 0;
                      return `${topic}\nå¹³å‡é›£æ˜“åº¦: ${rating}`;
                    },
                    color: '#fff',
                    font: {
                        weight: 'bold',
                        size: 12
                    },
                    textAlign: 'center'
                  },
                  tooltip: {
                      displayColors: false,
                      callbacks: {
                          label: function(context) {
                              const index = context.dataIndex;
                              const topic = pieLabels[index];
                              const count = pieCounts[index];
                              const total = pieCounts.reduce((a, b) => a + b, 0);
                              const percentage = ((count / total) * 100).toFixed(1); // é¡Œæ•¸å æ¯”
                              return [`é¡Œæ•¸ ${count}`,
                                      `æ¯”ç‡ ${percentage}%`
                                      ];
                          }
                      }
                  },
                  legend: {
                      position: 'top'
                  }
              },
              onClick: (event, chartElement, chart) => {
                const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, false);
                if (points.length > 0) {
                    const index = points[0].index;
                    const topic = topicData[index].topic;  // æ³¨æ„æ˜¯ topicData è£¡çš„åŸå§‹ key
                    loadQuestionList(topic);
                }
              }
          },
          plugins: [ChartDataLabels]
      };
  
      new Chart(document.getElementById('topicPieChart'), config);

      function submitSuggestion(qid) {
        const textarea = document.getElementById(`suggestion-text-${qid}`);
        const suggestion = textarea.value.trim();
      
        if (!suggestion) {
          alert('è«‹è¼¸å…¥å»ºè­°å…§å®¹');
          return;
        }
      
        fetch('/quality/submit-suggestion/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: `question_id=${encodeURIComponent(qid)}&suggestion=${encodeURIComponent(suggestion)}`
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById(`suggestion-result-${qid}`).style.display = 'block';
          } else {
            alert('é€å‡ºå¤±æ•—ï¼š' + data.message);
          }
        })
        .catch(err => {
          console.error('é€å‡ºå»ºè­°å¤±æ•—', err);
          alert('ç™¼é€æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        });
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (const cookie of cookies) {
            const trimmed = cookie.trim();
            if (trimmed.startsWith(name + '=')) {
              cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
      
  </script>
</body>
</html>

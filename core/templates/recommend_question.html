{% load custom_filters %}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI é¡Œå‹ç²¾ç·´æ¨è–¦</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-5" data-question-id="{{ question.id }}">

{% if error %}
  <p class="text-danger">{{ error }}</p>
{% else %}
  <h2 class="mb-4">ğŸ¯ é¡Œå‹ç²¾ç·´æ¨è–¦ç³»çµ±</h2>
  <p><strong>é¡Œç›®ï¼š</strong> {{ question.content }}</p>

  <div class="d-grid gap-3 my-4">
    {% for key, value in question.options.items %}
      <button type="button" class="btn btn-outline-dark choice" data-value="{{ key }}">
        {{ key }}. {{ value }}
      </button>
    {% endfor %}
  </div>

  <div class="d-flex justify-content-center mt-4">
    <form method="post" id="answerForm">
      {% csrf_token %}
      <input type="hidden" name="answer" id="answerInput">
      <button type="submit" id="submitBtn" class="btn btn-primary px-4 py-2 fs-5">
        æäº¤ç­”æ¡ˆ
      </button>
    </form>
  </div>

  <!-- ğŸ†• è©³è§£å€å¡Š -->
  <div id="explanation" class="mt-4" style="display: none;">
    <div id="explanation-text" class="alert alert-info"></div>
  </div>

  <div class="d-flex justify-content-between mt-5">
    <a href="{% url 'ai_recommend' %}" class="btn btn-outline-secondary">ğŸ”„ å†æ¨è–¦ä¸€é¡Œ</a>
    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">â¬… å›ä¸»é </a>
  </div>

  <script>
    function selectOption(option) {
      const choices = document.querySelectorAll(".choice");
      choices.forEach(btn => btn.classList.remove("btn-primary", "btn-danger", "btn-success"));
      option.classList.add("btn-primary");
    }

    function submitAnswer(correctAnswer, explanationText) {
      const selected = document.querySelector(".choice.btn-primary");
      if (!selected) {
        alert("è«‹é¸æ“‡ä¸€å€‹ç­”æ¡ˆï¼");
        return;
      }

      const selectedValue = selected.getAttribute("data-value");
      const explanationDiv = document.getElementById("explanation");
      const explanationTextDiv = document.getElementById("explanation-text");

      selected.classList.remove("btn-primary");

      if (selectedValue === correctAnswer) {
        selected.classList.add("btn-success");
        explanationTextDiv.innerHTML = "<strong>âœ… æ­£ç¢ºï¼</strong> " + explanationText;
      } else {
        selected.classList.add("btn-danger");
        const correctBtn = document.querySelector(`[data-value='${correctAnswer}']`);
        if (correctBtn) correctBtn.classList.add("btn-success");

        explanationTextDiv.innerHTML =
          "<strong>âŒ éŒ¯èª¤ï¼</strong> " + explanationText;
      }

      explanationDiv.style.display = "block";
      document.getElementById("submitBtn").disabled = true;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const buttons = document.querySelectorAll(".choice");
      buttons.forEach(btn => {
        btn.addEventListener("click", () => selectOption(btn));
      });

      const form = document.getElementById("answerForm");
      if (form) {
        form.addEventListener("submit", (e) => {
          const selected = document.querySelector(".choice.btn-primary");
          if (selected) {
            document.getElementById("answerInput").value = selected.getAttribute("data-value");
            e.preventDefault();  // âŒ æ”¹ç‚º JS è©•åˆ†ï¼Œä¸é€å‡ºè¡¨å–®
            submitAnswer("{{ question.answer }}", `{{ explanation|escapejs }}`);
          } else {
            alert("è«‹é¸æ“‡ä¸€å€‹ç­”æ¡ˆï¼");
            e.preventDefault();
          }
        });
      }
    });
  </script>

{% endif %}

</body>
</html>
